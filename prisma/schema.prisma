// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Use DIRECT_URL for migrations (required for Neon pooler; use non-pooler host).
// For Neon: copy DATABASE_URL and remove "-pooler" from the host (e.g. ep-xxx-pooler... → ep-xxx...).
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum RoomType {
  SINGLE
  DOUBLE
  DELUXE
  STANDARD
  SUITE
  SUITE_PLUS
}

enum RoomStatus {
  AVAILABLE
  BOOKED
  MAINTENANCE
}

enum SlotType {
  MORNING
  AFTERNOON
  NIGHT
  FULL_DAY
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  RECEPTIONIST
  STAFF
}

enum InventoryTransactionType {
  IN
  OUT
}

enum FunctionHallStatus {
  AVAILABLE
  BOOKED
  MAINTENANCE
}

enum FunctionHallBookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  LEAVE
}

// Room Master
model Room {
  id                String      @id @default(cuid())
  roomNumber        String      @unique
  roomType          RoomType
  floor             Int
  basePrice         Float
  capacity          Int // Total capacity (adults + children)
  status            RoomStatus  @default(AVAILABLE)
  maintenanceReason String?     // When status=MAINTENANCE: e.g. "AC, Fans, Carpenter", "Electronics", "Plumbing"
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  slots       RoomSlot[]
  bookings    Booking[]
  assetLocations AssetLocation[]
}

// Room Slot / Availability
model RoomSlot {
  id          String      @id @default(cuid())
  roomId      String
  date        DateTime
  slotType    SlotType
  price       Float
  isAvailable Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  room        Room        @relation(fields: [roomId], references: [id], onDelete: Cascade)
  bookings    Booking[]
}

// Guest
model Guest {
  id            String      @id @default(cuid())
  name          String
  phone         String
  idProof       String?
  idProofType   String?     @default("AADHAR") // AADHAR, PAN_CARD, PASSPORT, DRIVING_LICENSE, VOTER_ID, OTHER
  guestType     String?     @default("WALK_IN") // WALK_IN, CORPORATE, OTA, GOVERNMENT, REGULAR, AGENT, FAMILY
  address       String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  bookings      Booking[]
}

// Booking (includes billing info - merged Bill table)
model Booking {
  id              String        @id @default(cuid())
  roomId          String
  slotId          String
  guestId         String
  bookingDate     DateTime      @default(now())
  checkIn         DateTime
  checkOut        DateTime
  flexibleCheckout Boolean      @default(false) // True when checkout time is not confirmed
  numberOfGuests  Int           @default(1)
  totalAmount     Float
  advanceAmount   Float         @default(0)
  balanceAmount   Float?
  gstAmount       Float         @default(0)
  applyGst        Boolean       @default(true)
  status          BookingStatus @default(PENDING)
  source          String?       @default("STAFF") // STAFF = management site (hoteltheretinue.in), ONLINE = public site (hoteltheretinueonline.in)
  bookingReference String?      @unique // Short code for "view my booking" (e.g. ABC12XY); used by public site
  groupBookingReference String? // Same ref shared by batch (multi-room); lookup returns all in group
  // Billing fields (merged from Bill table)
  billNumber      String?       @unique
  subtotal        Float?
  tax             Float         @default(0)
  discount        Float         @default(0)
  paidAmount      Float         @default(0)
  paymentStatus   PaymentStatus @default(PENDING)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  room            Room          @relation(fields: [roomId], references: [id])
  slot            RoomSlot      @relation(fields: [slotId], references: [id])
  guest           Guest         @relation(fields: [guestId], references: [id])
  history         BookingHistory[]

  // Indexes for performance (Phase 2)
  @@index([roomId, status])
  @@index([guestId])
  @@index([checkIn, checkOut])
  @@index([status, checkIn])
  @@index([status])
  @@index([paymentStatus])
  @@index([source])
  @@index([groupBookingReference])
}

// Inventory
model Inventory {
  id          String                  @id @default(cuid())
  itemName    String
  category    String
  quantity    Int
  unit        String
  minStock    Int
  isAsset     Boolean                 @default(false) // True for trackable assets like beds, AC, etc.
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  transactions InventoryTransaction[]
  assetLocations AssetLocation[]
}

// Asset Location - Track where inventory assets are located
model AssetLocation {
  id            String      @id @default(cuid())
  inventoryId   String
  roomId        String?     // Can be null for storage/unassigned
  functionHallId String?    // For convention hall assets
  quantity      Int         // How many of this item in this location
  condition     String      @default("GOOD") // GOOD, FAIR, POOR, DAMAGED
  notes         String?
  assignedDate  DateTime    @default(now())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  inventory     Inventory   @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  room          Room?       @relation(fields: [roomId], references: [id], onDelete: SetNull)
  functionHall  FunctionHall? @relation(fields: [functionHallId], references: [id], onDelete: SetNull)

  @@index([inventoryId])
  @@index([roomId])
  @@index([functionHallId])
}

// Inventory Transaction
model InventoryTransaction {
  id          String                  @id @default(cuid())
  inventoryId String
  type        InventoryTransactionType
  quantity    Int
  reference   String? // booking id or room id
  notes       String?
  createdAt   DateTime                @default(now())

  inventory   Inventory               @relation(fields: [inventoryId], references: [id])
}

// Staff
model Staff {
  id            String            @id @default(cuid())
  name          String
  role          String
  phone         String
  staffType     StaffType         @default(SALARY)  // SALARY = monthly salary, DAILY = daily wage
  salary        Float?            // Monthly salary for SALARY type
  dailyWage     Float?            // Daily rate for DAILY type
  businessUnit  BusinessUnit      @default(HOTEL)   // Which business they work for
  status        String            @default("ACTIVE")
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  attendance    Attendance[]
  salaryPayments SalaryPayment[]
}

enum StaffType {
  SALARY    // Monthly salary employees
  DAILY     // Daily wage workers
}

// Salary Payment - Track monthly salary payments
model SalaryPayment {
  id            String        @id @default(cuid())
  staffId       String
  month         Int           // 1-12
  year          Int
  amount        Float
  bonus         Float         @default(0)
  deductions    Float         @default(0)
  netAmount     Float         // amount + bonus - deductions
  paymentDate   DateTime
  paymentMethod String?       // Cash, Bank Transfer, etc.
  notes         String?
  createdBy     String?       // User ID who processed this
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  staff         Staff         @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, month, year])  // One payment per staff per month
  @@index([month, year])
  @@index([staffId])
}

// Attendance
model Attendance {
  id          String            @id @default(cuid())
  staffId     String
  date        DateTime
  status      AttendanceStatus
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  staff       Staff             @relation(fields: [staffId], references: [id], onDelete: Cascade)
}

// User (Authentication)
model User {
  id            String          @id @default(cuid())
  username      String          @unique
  email         String?         @unique
  password      String // hashed
  role          UserRole
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  passwordResets PasswordReset[]
  notifications Notification[]
}

// OTP verification (sign up / login: SMS via Fast2SMS or email until DLT approved)
model OtpVerification {
  id        String   @id @default(cuid())
  phone     String?  // 10-digit Indian mobile (when sending via SMS)
  email     String?  // when sending OTP via email (until Fast2SMS DLT approved)
  code      String   // 6-digit OTP
  purpose   String   @default("SIGNUP") // SIGNUP, LOGIN, etc.
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([phone, purpose])
  @@index([email, purpose])
  @@index([expiresAt])
}

// Customer (public-site sign-up: OTP-verified, no password)
model Customer {
  id           String   @id @default(cuid())
  phone        String   @unique // 10 digits, verified via OTP
  name         String
  email        String?
  address      String?
  passwordHash String?  // bcrypt hash; NULL for OTP-only users
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([phone])
  @@index([email])
}

// Booking History / Audit Trail (Phase 3)
model BookingHistory {
  id          String   @id @default(cuid())
  bookingId   String
  action      String   // CREATED, UPDATED, STATUS_CHANGED, CANCELLED, etc.
  changedBy   String?  // User ID
  changes     Json?    // What changed (before/after)
  notes       String?
  timestamp   DateTime @default(now())

  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([timestamp])
}

// Password Reset
model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  code      String   // 6-digit code
  email     String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([code])
  @@index([expiresAt])
}

// Function Hall
model FunctionHall {
  id          String             @id @default(cuid())
  name        String             @unique
  capacity    Int                // Max guests
  pricePerDay Float
  pricePerHour Float?
  amenities   String?            // JSON string of amenities (AC, Projector, Stage, etc.)
  description String?
  status      FunctionHallStatus @default(AVAILABLE)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  bookings    FunctionHallBooking[]
  assetLocations AssetLocation[]
}

// Function Hall Booking
model FunctionHallBooking {
  id              String                   @id @default(cuid())
  hallId          String
  customerName    String
  customerPhone   String
  customerEmail   String?
  eventType       String                   // Wedding, Birthday, Conference, etc.
  eventDate       DateTime
  startTime       String                   // e.g., "09:00"
  endTime         String                   // e.g., "21:00"
  expectedGuests  Int
  totalAmount     Float
  advanceAmount   Float                    @default(0)
  balanceAmount   Float
  specialRequests String?
  status          FunctionHallBookingStatus @default(PENDING)
  
  // Electricity Meter Readings
  meterReadingBefore  Float?              // Reading before event
  meterReadingAfter   Float?              // Reading after event
  unitsConsumed       Float?              // Calculated: after - before
  electricityUnitPrice Float?             // Price per unit (kWh)
  electricityCharges  Float?              // Calculated: units × price
  
  // Maintenance/Other charges
  maintenanceCharges  Float?              // Any maintenance charges
  otherCharges        Float?              // Any other charges
  otherChargesNote    String?             // Description of other charges
  
  // Grand total (hall + electricity + maintenance + other)
  grandTotal          Float?
  
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  hall            FunctionHall             @relation(fields: [hallId], references: [id])
  history         FunctionHallBookingHistory[]

  @@index([hallId, status])
  @@index([eventDate])
  @@index([status])
}

// Function Hall Booking History / Audit Trail (same as hotel BookingHistory)
model FunctionHallBookingHistory {
  id            String   @id @default(cuid())
  bookingId     String   // FunctionHallBooking id
  action        String   // CREATED, UPDATED, STATUS_CHANGED, CANCELLED, PAYMENT_RECEIVED, etc.
  changedBy     String?  // User ID
  changes       Json?    // What changed (before/after)
  notes         String?
  timestamp     DateTime @default(now())

  booking       FunctionHallBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([timestamp])
}

// Expense Category Enum
enum ExpenseCategory {
  MAINTENANCE
  UTILITIES
  SALARY
  SUPPLIES
  REPAIRS
  MARKETING
  MISCELLANEOUS
}

// Business Unit Enum
enum BusinessUnit {
  HOTEL        // The Retinue
  CONVENTION   // Buchirajuu Convention
  BOTH         // Shared expenses
}

// Expense/Maintenance Records
model Expense {
  id            String          @id @default(cuid())
  businessUnit  BusinessUnit    // HOTEL, CONVENTION, or BOTH
  category      ExpenseCategory
  description   String
  amount        Float
  date          DateTime
  month         Int             // 1-12 for easy monthly filtering
  year          Int
  vendor        String?         // Vendor/Supplier name
  invoiceNumber String?
  notes         String?
  createdBy     String?         // User ID who created this
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([businessUnit, month, year])
  @@index([category])
  @@index([date])
  @@index([month, year])
}

// Utility Type Enum
enum UtilityType {
  ELECTRICITY
  WATER
  GAS
  INTERNET
  OTHER
}

// Utility Bills - Track meter readings and calculate costs
model UtilityBill {
  id              String        @id @default(cuid())
  businessUnit    BusinessUnit  // HOTEL, CONVENTION, or BOTH
  utilityType     UtilityType
  
  // Meter readings
  previousReading Float
  currentReading  Float
  unitsConsumed   Float         // Calculated: currentReading - previousReading
  
  // Pricing
  unitPrice       Float         // Price per unit (e.g., ₹8 per kWh)
  fixedCharges    Float         @default(0) // Any fixed charges
  taxes           Float         @default(0) // Tax amount
  totalAmount     Float         // Calculated: (unitsConsumed * unitPrice) + fixedCharges + taxes
  
  // Billing period
  billingMonth    Int           // 1-12
  billingYear     Int
  billDate        DateTime
  dueDate         DateTime?
  
  // Payment tracking
  isPaid          Boolean       @default(false)
  paidDate        DateTime?
  paidAmount      Float?
  
  // Additional info
  meterNumber     String?
  billNumber      String?
  provider        String?       // Electricity board name, etc.
  notes           String?
  
  createdBy       String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([businessUnit, billingMonth, billingYear])
  @@index([utilityType])
  @@index([isPaid])
}

// Bank Account
model BankAccount {
  id            String              @id @default(cuid())
  accountName   String              // e.g., "Main Business Account", "Petty Cash"
  bankName      String?             // e.g., "SBI", "HDFC"
  accountNumber String?             // Last 4 digits or full (masked)
  accountType   BankAccountType     @default(SAVINGS)
  currentBalance Float              @default(0)
  isActive      Boolean             @default(true)
  notes         String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  transactions  BankTransaction[]

  @@index([isActive])
}

enum BankAccountType {
  SAVINGS
  CURRENT
  CASH
  OTHER
}

// Bank Transaction
model BankTransaction {
  id              String                @id @default(cuid())
  accountId       String
  type            BankTransactionType
  amount          Float
  balanceAfter    Float                 // Balance after this transaction
  description     String
  reference       String?               // Cheque number, UPI ref, etc.
  category        String?               // Salary, Rent, Booking Payment, etc.
  relatedTo       String?               // booking ID, expense ID, etc.
  transactionDate DateTime              @default(now())
  createdBy       String?
  createdAt       DateTime              @default(now())

  account         BankAccount           @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([type])
  @@index([transactionDate])
  @@index([category])
}

enum BankTransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER_IN
  TRANSFER_OUT
}

// Notifications (In-App)
model Notification {
  id        String   @id @default(cuid())
  userId    String   // Link to specific user
  title     String
  message   String
  type      String   @default("INFO") // INFO, SUCCESS, WARNING, ERROR, BOOKING, ALERT
  link      String?  // Optional link to resource (e.g., /bookings/123)
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}
